# Docker Setup for mTLS PoC

This document explains how to use Docker to run the Mutual TLS (mTLS) Proof of Concept in an isolated environment.

## Overview

The Docker setup provides an isolated environment for testing the mTLS PoC, with the following components:

1. **mtls-cert-generator**: A service that generates all required certificates
2. **mtls-server**: The Node.js HTTPS server with mTLS authentication
3. **mtls-client**: A client container for running tests against the server

## Prerequisites

- Docker Engine (20.10+)
- Docker Compose (2.0+)

## Directory Structure in Docker

```
/usr/src/app/
├── certs/               # Mounted from host for certificate persistence
├── server/              # Node.js server files
├── clients/             # Client test scripts
└── scripts/             # Utility scripts
```

## Getting Started

### Starting the Docker Environment

```bash
# Start all services
docker-compose up -d

# Or run with the automated test script
./scripts/docker-test.sh
```

### Manual Testing

You can manually test the server from the host machine:

```bash
# Test with valid certificate
curl --cacert certs/ca.crt --cert certs/client1.crt --key certs/client1.key https://localhost:8443/

# Test without certificate (should fail)
curl --cacert certs/ca.crt https://localhost:8443/
```

Or from within the client container:

```bash
# Enter the client container
docker exec -it mtls-client bash

# Run test with client1 certificate
curl --cacert certs/ca.crt --cert certs/client1.crt --key certs/client1.key https://mtls-server:8443/
```

## Docker Services Explained

### Certificate Generator (`mtls-cert-generator`)

This service runs once to generate all necessary certificates:

- CA certificate and key
- Server certificate and key
- Client certificates and keys (client1, client2)

The certificates are stored in the `certs/` directory which is mounted from the host, so they persist even if the container is removed.

### Server (`mtls-server`)

This service runs the Node.js HTTPS server with mTLS authentication. It:

- Listens on port 8443 (mapped to the host)
- Uses the certificates generated by the cert-generator service
- Validates client certificates against the CA

### Client (`mtls-client`)

This service provides an environment for testing the mTLS server:

- Has curl installed for HTTP requests
- Has access to all certificates
- Can run various test scenarios

## Troubleshooting

### Viewing Logs

```bash
# View server logs
docker-compose logs mtls-server

# View certificate generator logs
docker-compose logs cert-generator

# View client logs
docker-compose logs mtls-client
```

### Common Issues

#### Certificate Not Found

If you see errors about missing certificates, ensure the cert-generator service ran successfully:

```bash
docker-compose logs cert-generator
```

#### Connection Refused

If you can't connect to the server, check if it's running and listening on the expected port:

```bash
docker-compose ps
docker exec -it mtls-server netstat -tuln
```

#### Certificate Validation Failures

If certificate validation fails, verify that all certificates were generated by the same CA:

```bash
docker exec -it mtls-server openssl verify -CAfile certs/ca.crt certs/server.crt
docker exec -it mtls-server openssl verify -CAfile certs/ca.crt certs/client1.crt
```

## Stopping the Environment

```bash
# Stop and remove containers
docker-compose down

# Stop, remove containers, and remove volumes
docker-compose down -v
```
